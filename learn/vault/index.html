<!doctype html><html><head><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly.css><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly-addons.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/solid.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css><link rel=stylesheet href=/css/custom.css><title>HashiCorp Vault | Hybrid Cloud Patterns</title></head><body><div class=pf-c-page><header class=pf-c-page__header><div class=pf-c-page__header-brand><a href=/ class=pf-c-page__header-brand-link><img src=/images/hybrid_cloud_patterns.png alt="Hybrid Cloud Patterns"></a></div><div class=pf-c-page__header-tools><nav class="pf-c-nav pf-m-horizontal" role=navigation><ul class=pf-c-nav__list><li class=pf-c-nav__item><a class=pf-c-nav__link href=/patterns/ title=Patterns>Patterns</a></li><li class="pf-c-nav__item pf-m-current"><a class=pf-c-nav__link href=/learn/ title=Learn>Learn</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/contribute/ title=Contribute>Contribute</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/blog/ title=Blog>Blog</a></li></ul></nav></div></header><div class=pf-c-page__sidebar><div class=pf-c-page__sidebar-body><div class=pf-c-nav><ul class=pf-c-nav__list><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/about/ class=pf-c-nav__link>Hybrid Cloud Patterns</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/quickstart/ class=pf-c-nav__link>Patterns quick start</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/infrastructure/ class=pf-c-nav__link>Infrastructure</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/workflow/ class=pf-c-nav__link>Workflow</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/secrets/ class=pf-c-nav__link>Secrets</a><section class=pf-c-nav__subnav><ul class=pf-c-nav__list><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/vault/ class="pf-c-nav__link pf-m-current">HashiCorp Vault</a></li></ul></section></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/faq/ class=pf-c-nav__link>FAQ</a></li></ul></div></div></div><main class=pf-c-page__main><section class=pf-c-page__main-section><div class="pf-l-grid pf-m-gutter"><div class="pf-l-grid__item pf-m-8-col"><div class=pf-c-content><div class=pf-c-content><h1 id=deploying-hashicorp-vault-in-a-validated-pattern>Deploying HashiCorp Vault in a validated pattern</h1><h1 id=prerequisites>Prerequisites</h1><p>You have deployed/installed a validated pattern using the instructions provided for that pattern. This should include setting having logged into the cluster using <code>oc login</code> or setting you <code>KUBECONFIG</code> environment variable and running a <code>make install</code>.</p><h1 id=setting-up-hashicorp-vault>Setting up HashiCorp Vault</h1><p>Any validated pattern that uses HashiCorp Vault already has deployed Vault as part of the <code>make install</code>. To verify that Vault is installed you can first see that the <code>vault</code> project exists and then select the Workloads/Pods:</p><p><a href=/images/secrets/vault-pods.png><img src=/images/secrets/vault-pods.png alt="Vault Pods"></a></p><p>In order to setup HashiCorp Vault there are two different ways, both of which happen automatically as part of the <code>make install</code> command:</p><ol><li>Inside the cluster directly when the helm value <code>clusterGroup.insecureUnsealVaultInsideCluster</code> is set to <code>true</code>. With this method a cronjob will run every five minutes inside the <code>imperative</code> namespace and unseal, initialize and configure the vault. The vault&rsquo;s unseal keys and root token will be stored inside a secret called <code>vaultkeys</code> in the <code>imperative</code> namespace. <strong>It is considered best practice</strong> to copy the content of that secret offline, store it securely and then delete it.</li><li>On the user&rsquo;s computer when the helm value <code>clusterGroup.insecureUnsealVaultInsideCluster</code> is set to <code>false</code>. This will store the json containing containing both vault root token and unseal keys inside a file called <code>common/pattern-vault.init</code>. It is recommended to encrypt this file or store it securely.</li></ol><p>An example output is the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;recovery_keys_b64&#34;</span>: [],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;recovery_keys_hex&#34;</span>: [],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;recovery_keys_shares&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;recovery_keys_threshold&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;root_token&#34;</span>: <span style=color:#e6db74>&#34;hvs.VNFq7yPuZljq2VDJTkgAMs2Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;unseal_keys_b64&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;+JJjKgZyEB1rbKlXs1aTuC+PBivukIlnpoe7bH4qc7TL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;X2ib6LNZw+kOQH1WYR9t3RE2SgB5WbEf2FfD40OybNXf&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;A4DIhv9atLIQsqqyDAYkmfEJPYhFVuKGSGYwV7WCtGcL&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;ZWkQ7+qtgmClKdlNKWcdpvyxArm07P9eArHZB4/CMZWn&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;HXakF073+Kk7oOpAFbGlKIWYApzUhC/F1LDfowF/M1LK&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;unseal_keys_hex&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;f892632a0672101d6b6ca957b35693b82f8f062bee908967a687bb6c7e2a73b4cb&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;5f689be8b359c3e90e407d56611f6ddd11364a007959b11fd857c3e343b26cd5df&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;0380c886ff5ab4b210b2aab20c062499f1093d884556e28648663057b582b4670b&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;656910efeaad8260a529d94d29671da6fcb102b9b4ecff5e02b1d9078fc23195a7&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;1d76a4174ef7f8a93ba0ea4015b1a5288598029cd4842fc5d4b0dfa3017f3352ca&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;unseal_shares&#34;</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;unseal_threshold&#34;</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The vault&rsquo;s root token is needed to log into the vault&rsquo;s UI and the unseal keys are needed whenever the vault pods are restarted.
In the OpenShift console click on the nine box at the top and click on the <code>vault</code> line:
[<img src=/images/secrets/vault-nine-box.png alt="Vault Nine Box">]</p><p>Copy the <code>root_token</code> field which in the example above has the value <code>hvs.VNFq7yPuZljq2VDJTkgAMs2Z</code> and paste it in the sign-in page:</p><p><a href=/images/secrets/vault-signin.png><img src=/images/secrets/vault-signin.png alt="Vault Sign In"></a></p><p>After signing in you will see the secrets that have been created.</p><p><a href=/images/secrets/vault-secrets-engine-screen.png><img src=/images/secrets/vault-secrets-engine-screen.png alt="Vault Secrets Engine"></a></p><h1 id=unseal>Unseal</h1><p>If you don&rsquo;t see the sign in page but instead see an unseal page, something may have happened the cluster and you need to unseal it again. Instead of using <code>make vault-init</code> you should run <code>make vault-unseal</code>. You can also unseal it manually by running <code>vault operator unseal</code> inside the <code>vault-0</code> pod in the <code>vault</code> namespace.</p><h1 id=whats-next>What&rsquo;s next?</h1><p>Check with the validated pattern instructions to see if there are further steps you need to perform. Sometimes this might be deploying a pattern on an edge cluster and checking to see if the correct Vault handshaking and updating occurs.</p></div></div></div><div class="pf-l-grid__item pf-m-4-col"><nav class="pf-c-jump-links pf-m-vertical" aria-label=Contents><div class=pf-c-jump-links__main><div class=pf-c-jump-links__header><div class=pf-c-jump-links__label><h1>Table of Contents</h1></div></div><nav id=TableOfContents><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#deploying-hashicorp-vault-in-a-validated-pattern>Deploying HashiCorp Vault in a validated pattern</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#prerequisites>Prerequisites</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#setting-up-hashicorp-vault>Setting up HashiCorp Vault</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#unseal>Unseal</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#whats-next>What&rsquo;s next?</a></li></ul></nav></div></nav></div></div></section></main></div><div><div style=padding:10px;text-align:center;color:#d2d2d2;background-color:#000>Copyright &copy; 2022 Red Hat, Inc.</div></div></body></html>