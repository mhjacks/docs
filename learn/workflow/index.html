<!doctype html><html><head><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly.css><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly-addons.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/solid.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css><link rel=stylesheet href=/css/custom.css><title>Workflow | Hybrid Cloud Patterns</title></head><body><div class=pf-c-page><header class=pf-c-page__header><div class=pf-c-page__header-brand><a href=/ class=pf-c-page__header-brand-link><img src=/images/hybrid_cloud_patterns.png alt="Hybrid Cloud Patterns"></a></div><div class=pf-c-page__header-tools><nav class="pf-c-nav pf-m-horizontal" role=navigation><ul class=pf-c-nav__list><li class=pf-c-nav__item><a class=pf-c-nav__link href=/patterns/ title=Patterns>Patterns</a></li><li class="pf-c-nav__item pf-m-current"><a class=pf-c-nav__link href=/learn/ title=Learn>Learn</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/contribute/ title=Contribute>Contribute</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/blog/ title=Blog>Blog</a></li></ul></nav></div></header><div class=pf-c-page__sidebar><div class=pf-c-page__sidebar-body><div class=pf-c-nav><ul class=pf-c-nav__list><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/about/ class=pf-c-nav__link>Hybrid Cloud Patterns</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/quickstart/ class=pf-c-nav__link>Patterns quick start</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/infrastructure/ class=pf-c-nav__link>Infrastructure</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/workflow/ class="pf-c-nav__link pf-m-current">Workflow</a><section class=pf-c-nav__subnav><ul class=pf-c-nav__list><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/implementation/ class=pf-c-nav__link>Implementation Requirements</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/community/ class=pf-c-nav__link>Community Patterns</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/validated/ class=pf-c-nav__link>Validated Patterns</a></li></ul></section></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/secrets/ class=pf-c-nav__link>Secrets</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=/learn/faq/ class=pf-c-nav__link>FAQ</a></li></ul></div></div></div><main class=pf-c-page__main><section class=pf-c-page__main-section><div class="pf-l-grid pf-m-gutter"><div class="pf-l-grid__item pf-m-8-col"><div class=pf-c-content><div class=pf-c-content><h1 id=workflow>Workflow</h1><p>These patterns are designed to be composed of multiple components, and for those components to be used in gitops
workflows by consumers and contributors. To use the first pattern as an example, we maintain the <a href=/industrial-edge>Industrial Edge</a> pattern, which uses a <a href=https://github.com/hybrid-cloud-patterns/industrial-edge>repo</a> with pattern-specific logic and configuration as well as a <a href=https://github.com/hybrid-cloud-patterns/common>common repo</a> which has elements common to multiple patterns. The common repository is included in each pattern repository as a subtree.</p><h2 id=consuming-a-pattern>Consuming a pattern</h2><ol><li><p>Fork the pattern repository on GitHub to your workspace (GitHub user or organization). It is necessary to fork because your fork will be updated as part of the GitOps and DevOps processes, and the main branch (by default) will be used in the automated workflows.</p></li><li><p>Clone the forked copy</p><p><code>git clone git@github.com:&lt;your-workspace>/industrial-edge.git</code></p></li><li><p>Create a local copy of the Helm values file that can safely include credentials</p></li></ol><p>DO NOT COMMIT THIS FILE
You do not want to push personal credentials to GitHub.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp values-secret.yaml.template ~/values-secret.yaml
</span></span><span style=display:flex><span>vi ~/values-secret.yaml
</span></span></code></pre></div><ol><li><p>Customize the deployment for your cluster</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>vi values-global.yaml
</span></span><span style=display:flex><span>git commit values-global.yaml
</span></span><span style=display:flex><span>git push
</span></span></code></pre></div></li></ol><h2 id=contributing>Contributing</h2><p>For contributions, we recommend adding the upstream repository as an additional remote, and making changes on a
branch other than main. Changes on this branch can then be merged to the <code>main</code> branch (to be reflected in the GitOps
workflows) and will be easier to make upstream, if you wish. Contributions from your forked <code>main</code> branch will contain, by design:</p><ol><li>Customizations to <code>values-global.yaml</code> and other files that are particular to your installation</li><li>Commits made by Tekton and other automated processes that will be particular to your installation</li></ol><p>To isolate changes for upstreaming (<code>hcp</code> is &ldquo;Hybrid Cloud Patterns&rdquo;, you can use a different remote and/or branch name
if you want):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git remote add hcp https://github.com/hybrid-cloud-patterns/industrial-edge
</span></span><span style=display:flex><span>git fetch --all
</span></span><span style=display:flex><span>git branch -b hcp-main -t hcp/main
</span></span><span style=display:flex><span>&lt;make changes on the hcp-main branch&gt;
</span></span><span style=display:flex><span>git push origin hcp-main
</span></span></code></pre></div><p>To update branch <code>hcp-main</code> with upstream changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git checkout hcp-main
</span></span><span style=display:flex><span>git pull --rebase
</span></span></code></pre></div><p>To reflect these changes in your forked repository (such as if you would like to submit a PR later):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git push origin hcp-main
</span></span></code></pre></div><p>If you want to integrate upstream pattern changes into your local GitOps process:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git checkout main
</span></span><span style=display:flex><span>git merge hcp-main
</span></span><span style=display:flex><span>git push origin main
</span></span></code></pre></div><p>Using this workflow, the <code>hcp-main</code> branch will:</p><ol><li>Be isolated from any changes that are being made by your local GitOps processes</li><li>Be merge-able (or cherry-pick-able) into your local main branch to be used by your local GitOps processes
(this is especially useful for tracking when any submodules, like common, update)</li><li>Be a good basis for submitting Pull Requests to be integrated upstream, since it will not contain your local configuration differences or your local GitOps commits</li></ol><h2 id=changing-subtrees>Changing subtrees</h2><p>Our patterns use the git subtree feature as a mechanism to promote modularity, so that multiple patterns can use the
same common basis. Over time we will move more functionality into common, to isolate the components that are
particular to each pattern, and standard usage conventions emerge. This will make the tools in common more powerful and featureful, and make it easier to develop new patterns. Normally, we will maintain the common subtree in the normal course of updates, and pulling changes from upstream will include any changes from common.</p><p>You only need to change subtrees if you want to test changes in the common/ area of the pattern repositories, or if you wish to contribute to the common/ repository itself in conjunction with one of the patterns. Using the pattern by itself <em>does not</em> require changing subtrees.</p><p>For the common cases (use and consumption of the pattern), users do not need to be aware that the pattern uses a subtree at all.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/&lt;your-workspace&gt;/industrial-edge
</span></span></code></pre></div><p>If you want to change and track your own version of common, you should fork and clone our common repository separately:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://github.com/&lt;your-workspace&gt;/common
</span></span></code></pre></div><p>Now, you can make changes in your fork&rsquo;s main branch, or else make a new branch and make changes there.</p><p>If you want to track these changes in your fork of the <em>pattern</em> repository (industrial-edge in this case), you will need to swap out the subtree in industrial-edge for the version of common you forked. We have provided a script to make this a bit easier:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>common/scripts/make_common_subtree.sh &lt;subtree_repo&gt; &lt;subtree_branch&gt; &lt;subtree_remote_name&gt;
</span></span></code></pre></div><p>This script will set up a new remote in your local working directory with the repository you specify. It will replace the common directory with a new common from the fork and branch you specify, and commit it. The script will <em>not</em> push the result.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>common/scripts/make_common_subtree.sh https://github.com/mhjacks/common.git wip-main common-subtree
</span></span></code></pre></div><p>This will replace common in the current repository with the wip-main branch from the common in mhjacks&rsquo;s common repository, and call the remote common-subtree.</p><p>From that point, changes from mhjacks&rsquo;s wip-main branch on mhjacks&rsquo;s fork of common can be pulled in this way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git subtree pull --prefix common common-subtree wip-main
</span></span></code></pre></div><p>When run without arguments, the script will run as if it had been given the following arguments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>common/scripts/make_common_subtree.sh https://github.com/hybrid-cloud-patterns/common.git main common-subtree
</span></span></code></pre></div><p>Which are the defaults the repository is normally configured with.</p><h2 id=subtree-vs-submodule>Subtree vs. Submodule</h2><p>It has always been important to us to be have a substrate for patterns that is as easy as possible to share amongst
multiple patterns. While it is possible to share changes between multiple unrelated git repositories, it is an almost
entirely manual process, prone to error. We feel it is important to be able to provide a &ldquo;pull&rdquo; experience (i.e. one git &ldquo;pull&rdquo; type action) to update the shared components of a pattern. Two strategies exist for repository sharing in this way: submodule and subtree. We started with submodules but have since moved to subtree.</p><p>Atlassian has some good documentation on what subtree is <a href=https://blog.developer.atlassian.com/the-power-of-git-subtree/>here</a> and <a href=https://www.atlassian.com/git/tutorials/git-subtree>here</a>. In short, a subtree integrates another repository&rsquo;s history into a parent repository, which allows for most of the benefits of a submodule workflow, without most of the caveats.</p><p>Earlier versions of this document described the usage of patterns with submodules instead of subtrees. In the earliest stages of pattern development, we used submodules because the developers of the project were familiar with submodules and had used them previously, but we had not used subtrees. User feedback, as well as some of the unavoidable complexities of submodules, convinced us to try subtrees and we believe we will stick with that strategy. Some of the unavoidable complexities of submodules include:</p><ul><li>Having to remember to checkout repositories with <code>--recurse-submdules</code>, or else doing <code>git submodule init && git submodule sync</code>. Experienced developers asked in several of our support channels early on why common was empty.</li><li>Hoping that other tools that are interacting with the repository are compatible with the submodule approach. (To be fair, tools like ArgoCD and Tekton Pipelines did this very well; their support of submodules was one of the key reasons we started with submodules)</li><li>When changing branches on a submoduled repository, if the branch you were changing to was pointed to a different revision of the submoduled repository, the repository would show out of sync. While this behavior is correct, it can be surprising and difficult to navigate.</li><li>In disconnected environments, submodules require mirroring more repositories.</li><li>Developing with a fork of the submoduled repository means maintaining two forked repositories and multiple branches in both.</li></ul><p>Subtrees have some pitfalls as well. In the subtree strategy, it is easier to diverge from the upstream version of the subtree repository, and in fact with a typical <code>git clone</code>, the user may not be aware that a subtree is in use at all. This can be considered a feature, but could become problematic if the user/consumer later wants to update to a newer version of the subtree but local changes might conflict. Additionally, since subtrees are not as well understood generally, there can be some surprising effects. In practice, we have run into the following:</p><ul><li>Cherry picking from a subtree commit into the parent puts the change in the parent location, not the subtree</li></ul><h2 id=contributing-to-patterns-using-common-subtrees>Contributing to Patterns using Common Subtrees</h2><p>Once you have forked common and changed your subtree for testing, changes from your fork can then be proposed to [https://github.com/hybrid-cloud-patterns/common.git] and can then be integrated into other patterns. A change to upstream common for a particular upstream pattern would have to be done in two stages:</p><ol><li>PR the change into upstream&rsquo;s common</li><li>PR the updated common into the pattern repository</li></ol></div></div></div><div class="pf-l-grid__item pf-m-4-col"><nav class="pf-c-jump-links pf-m-vertical" aria-label=Contents><div class=pf-c-jump-links__main><div class=pf-c-jump-links__header><div class=pf-c-jump-links__label><h1>Table of Contents</h1></div></div><nav id=TableOfContents><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#workflow>Workflow</a><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#consuming-a-pattern>Consuming a pattern</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#contributing>Contributing</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#changing-subtrees>Changing subtrees</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#subtree-vs-submodule>Subtree vs. Submodule</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#contributing-to-patterns-using-common-subtrees>Contributing to Patterns using Common Subtrees</a></li></ul></li></ul></nav></div></nav></div></div></section></main></div><div><div style=padding:10px;text-align:center;color:#d2d2d2;background-color:#000>Copyright &copy; 2022 Red Hat, Inc.</div></div></body></html>