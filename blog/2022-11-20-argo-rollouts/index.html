<!doctype html><html><head><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly-addons.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/solid.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css><title>Progressive Delivery with Argo Rollouts | Hybrid Cloud Patterns</title></head><body><div class=pf-c-page><header class=pf-c-page__header><div class=pf-c-page__header-brand><a href=/ class=pf-c-page__header-brand-link><img src=/images/hybrid_cloud_patterns.png alt="Hybrid Cloud Patterns"></a></div><div class=pf-c-page__header-tools><nav class="pf-c-nav pf-m-horizontal" role=navigation><ul class=pf-c-nav__list><li class=pf-c-nav__item><a class=pf-c-nav__link href=/patterns/ title=Patterns>Patterns</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/learn/ title=Learn>Learn</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/contribute/ title=Contribute>Contribute</a></li><li class="pf-c-nav__item pf-m-current"><a class=pf-c-nav__link href=/blog/ title=Blog>Blog</a></li></ul></nav></div></header><div class=pf-c-page__sidebar><div class=pf-c-page__sidebar-body><div class=pf-c-nav><ul class=pf-c-nav__list><li class=pf-c-nav__item><a href=/blog/ class=pf-c-nav__link><span class="pf-c-icon pf-m-md pf-m-inline"><span class=pf-c-icon__content><i class="fas fa-angle-left" aria-hidden=true></i></span></span>
<span style=padding-left:10px>Back to Blog</span></a></li></ul></div></div></div><main class=pf-c-page__main><section class=pf-c-page__main-section><div class="pf-l-grid pf-m-gutter"><div class="pf-l-grid__item pf-m-8-col"><div class=pf-c-content><h1>Progressive Delivery with Argo Rollouts</h1><div style="margin:10px 0">by Jonny Rickard</div><div style="margin:10px 0">November 3, 2022</div><div style="margin:20px 0"><span class="pf-c-label pf-m-orange"><span class=pf-c-label__content>patterns</span></span>
<span class="pf-c-label pf-m-orange"><span class=pf-c-label__content>GitOps</span></span></div><hr class=pf-c-divider><h1 id=progressive-delivery-with-argo-rollouts>Progressive Delivery with Argo Rollouts</h1><h2 id=introduction>Introduction</h2><p>Progressive delivery is about the controlled deployment of an application. It is by no means a new concept when it comes to software deployment and delivery. The concept (maybe not in name) has been around for quite a while, and if you’ve done application or system updates prior to kubernetes some of these concepts will sound familiar. The <code>rollout</code> resource is a direct replacement of the kubernetes <code>deployment</code> resource. This allows for very easy conversion of an existing deployment into a rollout resource.</p><p>Additionally, Argo Rollouts can use metrics from a number of providers (we&rsquo;ll be using the default - prometheus) which can be used to abort a rollout if there are issues with the application deployment such as failed health checks, pod restarts ..etc. Using metrics to control the rollout is beyond the scope of this blog, but will be part of a future blog.</p><p><em>OpenShift and OpenShift-GitOps do not officially support argo-rollouts to date, but support should be expected in 2023</em></p><p>Blue/Green is the concept of having two versions of the same application running at the same time so that we can verify that the application updates are behaving the way they are supposed to. The blue (or production) application doesn’t change at all and the green (preview/updated application) is deployed beside it. While this is a tried and true approach it does have some drawbacks. One significant drawback to this strategy is that you will need to have enough capacity to support both applications running simultaneously. This can be a major hurdle in resource-constrained environments, or with applications that require a license to operate.</p><p><img src=/images/rollouts/bluegreen.png alt=bluegreen>
<em>Credits: argoproj.github.io</em></p><p>Canary is the more modern, more advanced approach to blue/green. With a canary deployment we deploy the new version of the application to a subset of our users, while the rest will continue with the original version. If there’s an issue with the new version, only that subset of users will be affected. With canary rollouts we can specify the percentage of traffic that gets allocated to the new application release as well as a timer for how long we want in between steps. This is ideal when you are trying to test a new feature and you want to gather metrics / data from live traffic.</p><p><img src=/images/rollouts/canary.png alt=canary>
<em>Credits: argoproj.github.io</em></p><p>In this blog, we’re going to use OpenShift Gitops to deploy the Argo Rollouts progressive delivery controller and we’re going to walk through a blue/green deployment as well as a canary deployment.</p><h2 id=preparation>Preparation</h2><p>Let’s start by deploying the argo-rollouts pattern from the <a href=https://github.com/hybrid-cloud-patterns/argo-rollouts>argo-rollouts</a>. For this demo, I have deployed a 3-Node compact cluster using <code>m5.2xlarge</code> machine types in AWS. This demo will only use rollouts to deploy onto a single cluster.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span>oc get nodes
</span></span><span style=display:flex><span>NAME                                         STATUS   ROLES           AGE   VERSION
</span></span><span style=display:flex><span>ip-10-0-137-28.us-east-2.compute.internal    Ready    master,worker   13h   v1.24.6+5157800
</span></span><span style=display:flex><span>ip-10-0-165-204.us-east-2.compute.internal   Ready    master,worker   13h   v1.24.6+5157800
</span></span><span style=display:flex><span>ip-10-0-206-142.us-east-2.compute.internal   Ready    master,worker   13h   v1.24.6+5157800
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span>oc get machines -n openshift-machine-api
</span></span><span style=display:flex><span>NAME                               PHASE     TYPE        REGION      ZONE         AGE
</span></span><span style=display:flex><span>argo-rollouts-7d9dd-master-0   Running   m5.2xlarge   us-east-2   us-east-2a   13h
</span></span><span style=display:flex><span>argo-rollouts-7d9dd-master-1   Running   m5.2xlarge   us-east-2   us-east-2b   13h
</span></span><span style=display:flex><span>argo-rollouts-7d9dd-master-2   Running   m5.2xlarge   us-east-2   us-east-2c   13h
</span></span></code></pre></div><p>If you&rsquo;ve never deployed OpenShift before, you could try <a href=https://cloud.redhat.com/learn/getting-started-red-hat-openshift-service-aws-rosa/deploy-rosa-cluster>ROSA</a> the pay-as-you-go OpenShift managed service.</p><p>Next, you&rsquo;ll need to create a fork of the <a href=https://github.com/hybrid-cloud-patterns/argo-rollouts/>argo-rollouts</a> repo.
Go there in a browser, make sure you’re logged in to GitHub, click the “Fork” button, and confirm the destination by clicking the big green &ldquo;Create fork&rdquo; button.</p><p>Next, <a href=https://hybrid-cloud-patterns.io/infrastructure/using-validated-pattern-operator/>install the Validated Patterns operator</a> from Operator Hub.</p><p>And finally, click through to the installed operator, and select the <code>Create instance</code> button and fill out the Create a Pattern form. Most of the defaults
are fine, but make sure you update the GitSpec URL to point to your fork of
<code>argo-rollouts</code>, rather than <code>https://github.com/hybrid-cloud-patterns/argo-rollouts</code>.</p><p>To see what’s going on, click on “Installed Operators” and then change the Project to “All Projects”. After a bit, you will see the following operators installed:
Advanced Cluster Manager for Kubernetes
multicluster engine for kubernetes
Red Hat OpenShift GitOps
Package Server
Validated Patterns Operator</p><p>Once everything is installed we need to clone our fork of the repository to our local machine. Go to your account in github and click the big green “code” button, and then click the “copy” icon to copy the url of the repository.</p><p>Switch over to your cli and type: git clone &lt;paste_the_url_just_copied> ; next, change directories into the repository.</p><p>Optionally, the argo project provides a plugin for the kubectl which can be used to manage rollouts in our cluster. This is totally optional and not required, however it does make it easy to track progress of the rollout. To install follow the <a href=https://argoproj.github.io/argo-rollouts/installation/#kubectl-plugin-installation>official install procedures</a>.</p><h2 id=argo-rollouts>Argo Rollouts</h2><p>In your copy of the repository, we can find the manifests that make up argo rollouts in <code>charts/all/argo-rollouts/templates</code>. Now we <em>COULD</em> use <code>oc/kubectl create -f</code> but that defeats the purpose of gitops! So we&rsquo;re going to use <code>openshift-gitops</code> and the validated pattern framework to deploy the argo rollouts controller for us.</p><p>If you are interested in understanding what each of the manifests are for, I encourage you to visit the <a href=https://argoproj.github.io/argo-rollouts/architecture/>argo rollouts architecture page</a> which details each resource.</p><p>Let&rsquo;s review how the framework is deploying argo-rollouts for us. Take a look at <code>values-hub.yaml</code> to see how argo rollouts is declared:</p><p>First, we tell argocd to create the <code>argo-rollouts</code> namespace</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>namespaces</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>open-cluster-management</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>vault</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>golang-external-secrets</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>argo-rollouts</span>
</span></span></code></pre></div><p>Next, we define a project, a project is an argocd resource that groups application resources together</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>projects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>hub</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>argo-rollouts</span>
</span></span></code></pre></div><p>Finally, we add a map for <code>argo-rollouts</code> where we define our application</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>applications</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>&lt;...omitted...&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>argo-rollouts</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>argo-rollouts</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>argo-rollouts</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>project</span>: <span style=color:#ae81ff>argo-rollouts</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>charts/all/argo-rollouts</span>
</span></span></code></pre></div><p>To watch the deployment in action, log in to your cluster console, and then select the “squared” drop down box and select “Hub ArgoCD”. After accepting the security warnings for self-signed certificates, in the ArgoCD login screen click “Login with OpenShift”, when prompted select “Allow user permissions”.</p><p>You are now in the ArgoCD console and can see the applications deployed (or being deployed). If you don’t see the rollouts application right away don’t fret, by default, ArgoCD’s reconciliation loop runs every 3 minutes.</p><p>After a few, you should see the following in your ArgoCD console.</p><p><img src=/images/rollouts/pattern_deployed.png alt="Pattern Deployed"></p><p>With Argo Rollouts deployed, we can start using progressive delivery! Let’s start with blue/green!</p><h2 id=bluegreen>Blue/Green</h2><p>When you use a blue/green deployment strategy you will have two instances of the application running simultaneously. The “blue” or production instance will continue to receive connections and run without change, the “green” or updated application will start and be available using a different service. You can create a route (or ingress) if you’d like, and then when satisfied promote the “green” application to production.</p><p>Once promoted the rollout will update the &ldquo;blue&rdquo; replicaset which will then scale the &ldquo;blue&rdquo; version of the pods down to zero. After the rollout promotion is completed we can check the rollout status using the argo rollouts plugin.</p><p>Let&rsquo;s add the bluegreen application to our pattern. The first thing we need to do is update the <code>values-hub.yaml</code> file.</p><ul><li><input checked disabled type=checkbox> Add <code>bluegreen</code> namespace to the list of namespaces to be created by openshift-gitops</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespaces</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>open-cluster-management</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>vault</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>golang-external-secrets</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>argo-rollouts</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>bluegreen</span>
</span></span></code></pre></div><ul><li><p><input checked disabled type=checkbox> We&rsquo;re going to create this application in the <code>argo-rollouts</code> project - this is just for simplicity in the demo.</p></li><li><p><input checked disabled type=checkbox> Add &lsquo;bluegreen&rsquo; application stanza under <code>Applications</code></p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>applications</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&lt;... omitted ...&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>bluegreen</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>bluegreen</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>bluegreen</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>project</span>: <span style=color:#ae81ff>argo-rollouts</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>charts/all/bluegreen</span>
</span></span></code></pre></div><p>When finished editing make sure that you commit your changes to git!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git commit -am <span style=color:#e6db74>&#34;Added blue-green application to the pattern&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push -u origin main
</span></span></code></pre></div><p>Our demo application is an example application that the argo project provides. We declare this image in the <code>values-global.yaml</code> file, and we will modify the tag to trigger the rollout.</p><p><code>values-global.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>rollout</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>argoproj/rollouts-demo:blue</span>
</span></span></code></pre></div><p>Review the snippet below to add bluegreen to the pattern!</p><p><img src=/videos/rollouts/bluegreen-values.gif alt=blue-green-values></p><p>Check that the application deployed successfully in the argocd user interface. If everything went well you should see something like this:</p><p><img src=/images/rollouts/bluegreen-success.png alt=bluegreen-success></p><p>With our demo application deployed, let&rsquo;s a rollout by changing the image tag in <code>values-global.yaml</code> to <code>green</code>.</p><p>Once we&rsquo;ve made the change we need to commit and push our changes to git</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span>git add values-global.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;triggering rollout with image update&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push -u origin main
</span></span></code></pre></div><p>Once argocd recognizes the update, the rollout controller will create a replicaset for the <code>green</code> application and will start the desired number of pods. The green application is using its own service and that service is exposed via a route. Once the replicaset has created the pods, the rollout will <code>pause</code> waiting for an action to either promote or abort the rollout.</p><p>We have two ways of viewing the rollout. The first is through UI in the argocd interface, and the other is using the argocd rollouts plugin. The UI doesn&rsquo;t provide as much detail as the plugin, so I&rsquo;ll show you what both look like for reference.</p><p>This is what the plugin shows us before the image tag has been detected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>oc argo rollouts get rollout bluegreen
</span></span><span style=display:flex><span>Name:            bluegreen
</span></span><span style=display:flex><span>Namespace:       bluegreen
</span></span><span style=display:flex><span>Status:          ✔ Healthy
</span></span><span style=display:flex><span>Strategy:        BlueGreen
</span></span><span style=display:flex><span>Images:          argoproj/rollouts-demo:blue <span style=color:#f92672>(</span>stable, active<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Replicas:
</span></span><span style=display:flex><span>  Desired:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Current:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Updated:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Ready:         <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Available:     <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                   KIND        STATUS     AGE  INFO
</span></span><span style=display:flex><span>⟳ bluegreen                            Rollout     ✔ Healthy  11m
</span></span><span style=display:flex><span>└──# revision:1
</span></span><span style=display:flex><span>   └──⧉ bluegreen-5f5746dc47           ReplicaSet  ✔ Healthy  11m  stable,active
</span></span><span style=display:flex><span>      ├──□ bluegreen-5f5746dc47-5wfnt  Pod         ✔ Running  11m  ready:1/1
</span></span><span style=display:flex><span>      └──□ bluegreen-5f5746dc47-q52cl  Pod         ✔ Running  11m  ready:1/1
</span></span></code></pre></div><p>Once the image tag has been detected and the rollout executed, this is what we see:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span>oc argo rollouts get rollout bluegreen
</span></span><span style=display:flex><span>Name:            bluegreen
</span></span><span style=display:flex><span>Namespace:       bluegreen
</span></span><span style=display:flex><span>Status:          ॥ Paused
</span></span><span style=display:flex><span>Message:         BlueGreenPause
</span></span><span style=display:flex><span>Strategy:        BlueGreen
</span></span><span style=display:flex><span>Images:          argoproj/rollouts-demo:blue <span style=color:#f92672>(</span>stable, active<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                 argoproj/rollouts-demo:green <span style=color:#f92672>(</span>preview<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Replicas:
</span></span><span style=display:flex><span>  Desired:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Current:       <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>  Updated:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Ready:         <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Available:     <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                   KIND        STATUS     AGE  INFO
</span></span><span style=display:flex><span>⟳ bluegreen                            Rollout     ॥ Paused   13m
</span></span><span style=display:flex><span>├──# revision:2
</span></span><span style=display:flex><span>│  └──⧉ bluegreen-69d5bcb78            ReplicaSet  ✔ Healthy  66s  preview
</span></span><span style=display:flex><span>│     ├──□ bluegreen-69d5bcb78-d5bjp   Pod         ✔ Running  66s  ready:1/1
</span></span><span style=display:flex><span>│     └──□ bluegreen-69d5bcb78-vnw4q   Pod         ✔ Running  66s  ready:1/1
</span></span><span style=display:flex><span>└──# revision:1
</span></span><span style=display:flex><span>   └──⧉ bluegreen-5f5746dc47           ReplicaSet  ✔ Healthy  13m  stable,active
</span></span><span style=display:flex><span>      ├──□ bluegreen-5f5746dc47-5wfnt  Pod         ✔ Running  13m  ready:1/1
</span></span><span style=display:flex><span>      └──□ bluegreen-5f5746dc47-q52cl  Pod         ✔ Running  13m  ready:1/1
</span></span></code></pre></div><p>In the argoCD interface this what the rollout looks like:</p><p><img src=/images/rollouts/bluegreen-nopromote.png alt="bluegreen before promotion"></p><p>If you look at the rollout resource you can see that it is paused. This is because it&rsquo;s waiting on an administrator to approve or cancel the deployment. Both applications are running side by side. Let&rsquo;s take a look at the routes!</p><p>The active/blue/production route:</p><p><img src=/images/rollouts/bluegreen-active.png alt=active></p><p>The preview/update/new route:</p><p><img src=/images/rollouts/bluegreen-preview.png alt=preview></p><p>Now if we promote the application, the green application will become the primary.</p><p>In the argoCD interface, click on the bluegreen application, in the application context click on the vertical ellipsis next to the bluegreen rollout, then click <code>promote-full</code> or click <code>abort</code>to back out.</p><p><img src=/images/rollouts/bluegree-promote.png alt=promote></p><p>Now if we take a look at our active route we can see that the color changed to green!</p><p><img src=/images/rollouts/bluegreen-route-promoted.png alt=promoted></p><p>You could do the same with the argo rollouts plugin:
<code>kubectl argo rollouts promote bluegreen</code> to back out of the rollout: <code>kubectl argo rollouts abort bluegreen</code></p><p>You can verify that the application has been promoted correctly by using the argo rollouts plugin, checking the route, or by checking the image tag in the rollout resource.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span>oc argo rollouts get rollout bluegreen
</span></span><span style=display:flex><span>Name:            bluegreen
</span></span><span style=display:flex><span>Namespace:       bluegreen
</span></span><span style=display:flex><span>Status:          ✔ Healthy
</span></span><span style=display:flex><span>Strategy:        BlueGreen
</span></span><span style=display:flex><span>Images:          argoproj/rollouts-demo:green <span style=color:#f92672>(</span>stable, active<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Replicas:
</span></span><span style=display:flex><span>  Desired:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Current:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Updated:       <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Ready:         <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  Available:     <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                  KIND        STATUS        AGE  INFO
</span></span><span style=display:flex><span>⟳ bluegreen                           Rollout     ✔ Healthy     26m
</span></span><span style=display:flex><span>├──# revision:2
</span></span><span style=display:flex><span>│  └──⧉ bluegreen-69d5bcb78           ReplicaSet  ✔ Healthy     13m  stable,active
</span></span><span style=display:flex><span>│     ├──□ bluegreen-69d5bcb78-d5bjp  Pod         ✔ Running     13m  ready:1/1
</span></span><span style=display:flex><span>│     └──□ bluegreen-69d5bcb78-vnw4q  Pod         ✔ Running     13m  ready:1/1
</span></span><span style=display:flex><span>└──# revision:1
</span></span><span style=display:flex><span>   └──⧉ bluegreen-5f5746dc47          ReplicaSet  • ScaledDown  26m
</span></span></code></pre></div><p>That&rsquo;s it for the blue-green deployment! Now let&rsquo;s take a look at a canary deployment.</p><h2 id=canary-rollout>Canary Rollout</h2><p>Canary deployments give us a lot of control on how our application is deployed. We can define what percentage of ingress traffic gets the canary or updated application and for how long. Rollouts can use metrics to determine the health of a rollout and make a decision to continue or abort the rollout based on those metrics.</p><p>This gives us insight into the health of our application as it is deployed, it gives insights into whether features are being used, and if they&rsquo;re working correctly. It really does open up all kinds of opportunities to learn a lot more about our applications and how they&rsquo;re used! Canary deployments are powerful and add flexibility to our application deployments. Either through a full application deployment or just testing a feature.</p><p>Let&rsquo;s get on with the demo!</p><p>The canary demo is located in <code>charts/all/canary-demo</code> and similar to how we deployed the bluegreen demo, we need to add the canary-demo application to our pattern for argocd to deploy it.</p><ul><li><input checked disabled type=checkbox> Add <code>canary-demo</code> namespace to the list of namespaces to be created by openshift-gitops</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespaces</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>open-cluster-management</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>vault</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>golang-external-secrets</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>argo-rollouts</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>canary-demo</span>
</span></span></code></pre></div><ul><li><p><input checked disabled type=checkbox> We&rsquo;re going to create this application in the <code>argo-rollouts</code> project - this is just for simplicity in the demo.</p></li><li><p><input checked disabled type=checkbox> Add &lsquo;canary-demo&rsquo; application stanza under <code>Applications</code></p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>applications</span>:
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>&lt;... omitted ...&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>bluegreen</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>canary-demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>canary-demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>project</span>: <span style=color:#ae81ff>argo-rollouts</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>charts/all/canary-demo</span>
</span></span></code></pre></div><p>When finished editing make sure that you commit your changes to git!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git commit -am <span style=color:#e6db74>&#34;Added canary application to the pattern&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push -u origin main
</span></span></code></pre></div><p>We can monitor the argocd interface for the application deployment. When the application has successfully deployed you should see something similar to the image below in the argocd interface:</p><p><img src=/images/rollouts/canary-demo-success.png alt=canary-demo-success></p><p>Let’s take a look at the rollout resource for the canary-demo application.</p><p><code>oc get rollout -o yaml canary-demo -n canary-demo</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span> <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>canary</span>:
</span></span><span style=display:flex><span>     <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>       - <span style=color:#f92672>setWeight</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>       - <span style=color:#f92672>pause</span>: {}
</span></span><span style=display:flex><span>       - <span style=color:#f92672>setWeight</span>: <span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>       - <span style=color:#f92672>pause</span>:
</span></span><span style=display:flex><span>           <span style=color:#f92672>duration</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>       - <span style=color:#f92672>setWeight</span>: <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>       - <span style=color:#f92672>pause</span>:
</span></span><span style=display:flex><span>           <span style=color:#f92672>duration</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>       - <span style=color:#f92672>setWeight</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>       - <span style=color:#f92672>pause</span>:
</span></span><span style=display:flex><span>           <span style=color:#f92672>duration</span>: <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>In the above snippet, we’re telling the rollout controller that we want 20% of the traffic
<code>setWeight: 20</code> to go to the canary for an indefinite amount of time <code>pause: {}</code>, in the next step we want 40% of the traffic to go to the canary for 10 seconds, then 60% for 10 seconds, then 80% for 10 seconds until 100% of the traffic is using the canary service.
These values can be modified to whatever makes sense for our deployment, maybe 10 seconds isn’t long enough to collect performance data on our feature canary and we need to run it for a bit longer.</p><p>Our active service before the rollout looks like this:</p><p><img src=/videos/rollouts/active-before-canary.gif alt=active></p><p>So let&rsquo;s trigger a rollout by changing the image tag! Edit the <code>values-global.yaml</code> and change the tag from <code>blue</code> to <code>red</code></p><p>Make sure you push your changes to git!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git commit -am <span style=color:#e6db74>&#34;Change canary image tag&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git push -u origin main
</span></span></code></pre></div><p>When the canary rollout occurs it removes one pod from the existing replicaset to support the canary replicaset. Let&rsquo;s use the argo rollout plugin to see what this looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>oc argo rollouts get rollout canary-demo
</span></span><span style=display:flex><span>Name:            canary-demo
</span></span><span style=display:flex><span>Namespace:       canary-demo
</span></span><span style=display:flex><span>Status:          ॥ Paused
</span></span><span style=display:flex><span>Message:         CanaryPauseStep
</span></span><span style=display:flex><span>Strategy:        Canary
</span></span><span style=display:flex><span>  Step:          1/8
</span></span><span style=display:flex><span>  SetWeight:     <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>  ActualWeight:  <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>Images:          argoproj/rollouts-demo:blue <span style=color:#f92672>(</span>stable<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                 argoproj/rollouts-demo:red <span style=color:#f92672>(</span>canary<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Replicas:
</span></span><span style=display:flex><span>  Desired:       <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>  Current:       <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>  Updated:       <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  Ready:         <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>  Available:     <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                     KIND        STATUS     AGE    INFO
</span></span><span style=display:flex><span>⟳ canary-demo                            Rollout     ॥ Paused   8m45s
</span></span><span style=display:flex><span>├──# revision:2
</span></span><span style=display:flex><span>│  └──⧉ canary-demo-6ffd7b9658           ReplicaSet  ✔ Healthy  39s    canary
</span></span><span style=display:flex><span>│     └──□ canary-demo-6ffd7b9658-dhhph  Pod         ✔ Running  38s    ready:1/1
</span></span><span style=display:flex><span>└──# revision:1
</span></span><span style=display:flex><span>   └──⧉ canary-demo-7d984ffb4c           ReplicaSet  ✔ Healthy  8m45s  stable
</span></span><span style=display:flex><span>      ├──□ canary-demo-7d984ffb4c-5hdsr  Pod         ✔ Running  8m45s  ready:1/1
</span></span><span style=display:flex><span>      ├──□ canary-demo-7d984ffb4c-6wtjq  Pod         ✔ Running  8m45s  ready:1/1
</span></span><span style=display:flex><span>      ├──□ canary-demo-7d984ffb4c-9vnq9  Pod         ✔ Running  8m45s  ready:1/1
</span></span><span style=display:flex><span>      └──□ canary-demo-7d984ffb4c-zh2bj  Pod         ✔ Running  8m45s  ready:1/1
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>
</span></span><span style=display:flex><span>oc get replicasets
</span></span><span style=display:flex><span>NAME                     DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>canary-demo-6ffd7b9658   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       47s
</span></span><span style=display:flex><span>canary-demo-7d984ffb4c   <span style=color:#ae81ff>4</span>         <span style=color:#ae81ff>4</span>         <span style=color:#ae81ff>4</span>       8m53s
</span></span></code></pre></div><p>In the argoCD interface we see that the rollout is paused just like with blue-green</p><p><img src=/images/rollouts/canary-paused.png alt=canary></p><p>But what about our application - we said we only want 20% of the traffic to go to the new app:</p><p><img src=/videos/rollouts/canary-demo.gif alt=demo></p><p>That is awesome! So now let&rsquo;s promote the application and see what happens - the expectation is that it will incrementally update the percentage of connections to the new application until completely promoted.</p><p><img src=/videos/rollouts/canary-fullpromote.gif alt=fullpromote></p><p>Let&rsquo;s take a look at what it looks like using the argo rollouts plugin</p><p><img src=/videos/rollouts/canary-plugin.gif alt="argo rollout plugin"></p><h2 id=conclusion>Conclusion</h2><p>Argo Rollouts makes progressive delivery of our applications super easy. Whether you want to deploy using blue-green or the more advanced canary rollout is up to you. The canary rollout is very powerful and as we saw gives us the ultimate control, with insights and flexibility to deploy applications. There is so much more that argo rollouts can do - this demo barely scratches the surface! Keep an eye out for argo rollouts as part of openshift-gitops in &lsquo;23.</p></div></div><aside class="pf-l-grid__item pf-m-4-col pf-c-jump-links pf-m-vertical sticky pf-m-expandable pf-m-non-expandable-on-2xl" aria-label="Table of contents"><div class=pf-c-jump-links__header><div class=pf-c-jump-links__label><h1>Table of Contents</h1></div></div><nav id=TableOfContents><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#progressive-delivery-with-argo-rollouts>Progressive Delivery with Argo Rollouts</a><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#introduction>Introduction</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#preparation>Preparation</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#argo-rollouts>Argo Rollouts</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#bluegreen>Blue/Green</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#canary-rollout>Canary Rollout</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#conclusion>Conclusion</a></li></ul></li></ul></nav></aside></div></section><footer id=footer class="footer-dark pf-m-no-fill pf-l-flex footer-center"><div class=pf-l-flex__item><a href=//www.redhat.com target=top aria-label="Visit Red Hat.com"><img src=/images/RHlogo.svg alt="Red Hat logo" width=145px height=613px></a><span class=site-copyright>Copyright &copy; 2023 Red Hat, Inc.</span></div></footer></main></div></body></html>