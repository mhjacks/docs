<!doctype html><html><head><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly-addons.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/solid.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css><title>Managed cluster sites | Hybrid Cloud Patterns</title></head><body><div class=pf-c-page><header class=pf-c-page__header><div class=pf-c-page__header-brand><a href=/ class=pf-c-page__header-brand-link><img src=/images/hybrid_cloud_patterns.png alt="Hybrid Cloud Patterns"></a></div><div class=pf-c-page__header-tools><nav class="pf-c-nav pf-m-horizontal" role=navigation><ul class=pf-c-nav__list><li class="pf-c-nav__item pf-m-current"><a class=pf-c-nav__link href=/patterns/ title=Patterns>Patterns</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/learn/ title=Learn>Learn</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/contribute/ title=Contribute>Contribute</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/blog/ title=Blog>Blog</a></li></ul></nav></div></header><div class=pf-c-page__sidebar><div class=pf-c-page__sidebar-body><div class=pf-c-nav><ul class=pf-c-nav__list><li class=pf-c-nav__item><a href=/patterns/ class=pf-c-nav__link><span class="pf-c-icon pf-m-md pf-m-inline"><span class=pf-c-icon__content><i class="fas fa-angle-left" aria-hidden=true></i></span></span>
<span style=padding-left:10px>Back to Patterns</span></a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/multicloud-gitops/ class=pf-c-nav__link>Multicloud GitOps</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/multicloud-gitops/getting-started/ class=pf-c-nav__link>Getting Started</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/multicloud-gitops/managed-cluster/ class="pf-c-nav__link pf-m-current">Managed cluster sites</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/multicloud-gitops/cluster-sizing/ class=pf-c-nav__link>Cluster Sizing</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/multicloud-gitops/imperative-actions/ class=pf-c-nav__link>Imperative Actions</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/multicloud-gitops/ideas-for-customization/ class=pf-c-nav__link>Ideas for Customization</a></li></ul></div></div></div><main class=pf-c-page__main><section class=pf-c-page__main-section><div class="pf-l-grid pf-m-gutter"><div class="pf-l-grid__item pf-m-8-col"><div class=pf-c-content><div class=pf-c-content><h1 id=attach-a-managed-cluster-edge-to-the-management-hub>Attach a managed cluster (edge) to the management hub</h1><h2 id=understanding-red-hat-advanced-cluster-management-requirements>Understanding Red Hat Advanced Cluster Management requirements</h2><p>Allow Red Hat Advanced Cluster Management (RHACM) to deploy the managed cluster application to a subset of clusters.</p><p>By default the <code>clusterGroup</code> applications are deployed on all clusters that RHACM manages. In the <code>value-hub.yaml</code>, file add a <code>managedClusterCgroup</code> for each cluster or group of clusters that you want to manage as one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>managedClusterGroups</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>region-one</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>helmOverrides</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>clusterGroup.isHubCluster</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>clusterSelector</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>clusterGroup</span>: <span style=color:#ae81ff>region-one</span>
</span></span></code></pre></div><p>The above YAML file segment deploys the <code>clusterGroup</code> applications on managed clusters with the label
<code>clusterGroup=region-one</code>. Specific subscriptions and Operators, applications and projects for that <code>clusterGroup</code> are then managed in a <code>value-region-one.yaml</code> file. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>namespaces</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>config-demo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>projects</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>config-demo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>applications</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>config-demo</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config-demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>config-demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>project</span>: <span style=color:#ae81ff>config-demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>charts/all/config-demo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#Subscriptions can be added too - multicloud-gitops at present does not require subscriptions on its managed clusters</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#subscriptions:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#  example-subscription:</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#    name: example-operator</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#    namespace: example-namespace</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#    channel: example-channel</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#    csv: example-operator.v1.0.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>subscriptions</span>:
</span></span></code></pre></div><p><strong>Important:</strong>
Ensure that you commit the changes and push them to GitHub so that GitOps can fetch your changes and apply them.</p><h2 id=deploying-a-managed-cluster>Deploying a managed cluster</h2><h3 id=prerequisites>Prerequisites</h3><ul><li>An OpenShift cluster<ul><li>To create an OpenShift cluster, go to the <a href=https://console.redhat.com/>Red Hat Hybrid Cloud console</a>.</li><li>Select <strong>OpenShift -> Clusters -> Create cluster</strong>.</li></ul></li></ul><p>To join the managed cluster to the management hub, you can:</p><ul><li>Use the Red Hat Advanced Cluster Management (RHACM) web console</li><li>Use the <code>cm</code> tool</li><li>Use the <code>clusteradm</code> tool</li></ul><h2 id=using-red-hat-advanced-cluster-management-web-console-to-set-up-managed-cluster>Using Red Hat Advanced Cluster Management web console to set up managed cluster</h2><p>After RHACM is installed, a message regarding a &ldquo;Web console update is available&rdquo; might be displayed.
Click the &ldquo;Refresh web console&rdquo; link.</p><p><img src=/images/web-console-update-message.png alt=update-web-console title="Update web console"></p><ol><li>In the left navigation panel of web console, click <strong>local-cluster</strong>. Select <strong>All Clusters</strong>. The RHACM web console is displayed with <strong>Cluster</strong>* on the left navigation panel.</li></ol><p><img src=/images/local-all-cluster-pulldown.png alt=launch-acm-console title="Launch ACM console"></p><ol start=2><li>On the <strong>Managed clusters</strong> tab, click <strong>Import cluster</strong>.</li></ol><p><img src=/images/import-cluster.png alt=import-cluster title="Select Import cluster"></p><ol start=3><li>On the <strong>Import an existing cluster</strong> page, enter the cluster name and choose <strong>Kubeconfig</strong> as the &ldquo;import mode&rdquo;. Add the tag <code>clusterGroup=region-one</code>. Click <strong>Import</strong>.</li></ol><p><img src=/images/import-with-kubeconfig.png alt=import-with-kubeconfig title="Import using kubeconfig"></p><p>You can now skip to the section <a href=#managed-cluster-is-joined>Managed cluster is joined</a> but ignore the part about adding the site tag.</p><h2 id=using-the-cm-tool-to-set-up-a-managed-cluster>Using the <code>cm</code> tool to set up a managed cluster</h2><ol><li><p>Install the <code>cm</code> (cluster management) command-line tool. See details <a href=https://github.com/open-cluster-management/cm-cli/#installation>here</a></p></li><li><p>Obtain the KUBECONFIG file from the managed-cluster cluster.</p></li><li><p>On the command-line login into the management hub cluster (use <code>oc login</code> or export the KUBECONFIG).</p></li><li><p>Run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cm attach cluster --cluster &lt;cluster-name&gt;  --cluster-kubeconfig &lt;path-to-KUBECONFIG&gt;
</span></span></code></pre></div></li></ol><p>Skip to the section <a href=#managed-cluster-is-joined>Managed cluster is joined</a></p><h2 id=using-the-clusteradm-tool-to-set-up-a-managed-cluster>Using the <code>clusteradm</code> tool to set up a managed cluster</h2><p>You can also use <code>clusteradm</code> to join a cluster. The following instructions explain what needs to be done. <code>clusteradm</code> is still in testing.</p><ol><li><p>To deploy a edge cluster you will need to get the management hub cluster&rsquo;s token. You will need to install <code>clusteradm</code>. On the existing <em>management hub cluster</em>:</p><p><code>clusteradm get token</code></p></li><li><p>When you run the <code>clusteradm</code> command above it replies with the token and also shows you the command to use on the managed cluster. So first you must login to the managed cluster</p><p><code>oc login</code>
or</p><p><code>export KUBECONFIG=~/my-ocp-env/managed-cluster</code></p></li><li><p>Then request to that the managed cluster join the management hub</p><p><code>clusteradm join --hub-token &lt;token from clusteradm get token command > &lt;managed cluster name></code></p></li><li><p>Back on the hub cluster accept the join request</p><p><code>clusteradm accept --clusters &lt;managed-cluster-name></code></p></li></ol><p>Skip to the section <a href=#managed-cluster-is-joined>Managed cluster is joined</a></p><h2 id=managed-cluster-is-joined>Managed cluster is joined</h2><h3 id=designate-the-new-cluster-as-a-managed-cluster-site>Designate the new cluster as a managed cluster site</h3><p>Now that ACM is no longer deploying the managed cluster applications everywhere, we need
to explicitly indicate that the new cluster has the managed cluster role. <strong>If you haven&rsquo;t tagged the cluster</strong> as <code>clusterGroup=region-one</code> then we can that here.</p><p>We do this by adding the label referenced in the managedSite&rsquo;s <code>clusterSelector</code>.</p><ol><li><p>Find the new cluster</p><p><code>oc get managedcluster.cluster.open-cluster-management.io</code></p></li><li><p>Apply the label</p><p><code>oc label managedcluster.cluster.open-cluster-management.io/YOURCLUSTER site=managed-cluster</code></p></li></ol><h3 id=verification>Verification</h3><p>Go to your managed cluster (edge) OpenShift console and check for the <code>open-cluster-management-agent</code> pod being launched. Be patient, it will take a while for the RHACM agent and <code>agent-addons</code> to launch. After that, the OpenShift GitOps Operator is installed. On successful installation, launch the OpenShift GitOps (ArgoCD) console from the top right of the OpenShift console.</p></div></div></div><aside class="pf-l-grid__item pf-m-4-col pf-c-jump-links pf-m-vertical sticky pf-m-expandable pf-m-non-expandable-on-2xl" aria-label="Table of contents"><div class=pf-c-jump-links__header><div class=pf-c-jump-links__label><h1>Table of Contents</h1></div></div><nav id=TableOfContents><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#attach-a-managed-cluster-edge-to-the-management-hub>Attach a managed cluster (edge) to the management hub</a><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#understanding-red-hat-advanced-cluster-management-requirements>Understanding Red Hat Advanced Cluster Management requirements</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#deploying-a-managed-cluster>Deploying a managed cluster</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#using-red-hat-advanced-cluster-management-web-console-to-set-up-managed-cluster>Using Red Hat Advanced Cluster Management web console to set up managed cluster</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#using-the-cm-tool-to-set-up-a-managed-cluster>Using the <code>cm</code> tool to set up a managed cluster</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#using-the-clusteradm-tool-to-set-up-a-managed-cluster>Using the <code>clusteradm</code> tool to set up a managed cluster</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#managed-cluster-is-joined>Managed cluster is joined</a></li></ul></li></ul></nav></aside></div></section><footer id=footer class="footer-dark pf-m-no-fill pf-l-flex footer-center"><div class=pf-l-flex__item><a href=//www.redhat.com target=top aria-label="Visit Red Hat.com"><img src=/images/RHlogo.svg alt="Red Hat logo" width=145px height=613px></a><span class=site-copyright>Copyright &copy; 2023 Red Hat, Inc.</span></div></footer></main></div></body></html>