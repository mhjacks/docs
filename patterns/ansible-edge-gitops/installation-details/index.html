<!doctype html><html><head><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly.css><link rel=stylesheet href=https://hybrid-cloud-patterns.io/sass/patternfly-addons.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/solid.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css><link rel=stylesheet href=/css/custom.css><title>Installation Details | Hybrid Cloud Patterns</title></head><body><div class=pf-c-page><header class=pf-c-page__header><div class=pf-c-page__header-brand><a href=/ class=pf-c-page__header-brand-link><img src=/images/hybrid_cloud_patterns.png alt="Hybrid Cloud Patterns"></a></div><div class=pf-c-page__header-tools><nav class="pf-c-nav pf-m-horizontal" role=navigation><ul class=pf-c-nav__list><li class="pf-c-nav__item pf-m-current"><a class=pf-c-nav__link href=/patterns/ title=Patterns>Patterns</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/learn/ title=Learn>Learn</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/contribute/ title=Contribute>Contribute</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/blog/ title=Blog>Blog</a></li></ul></nav></div></header><div class=pf-c-page__sidebar><div class=pf-c-page__sidebar-body><div class=pf-c-nav><ul class=pf-c-nav__list><li class=pf-c-nav__item><a href=/patterns/ class=pf-c-nav__link><span class="pf-c-icon pf-m-md pf-m-inline"><span class=pf-c-icon__content><i class="fas fa-angle-left" aria-hidden=true></i></span></span>
<span style=padding-left:10px>Back to Patterns</span></a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/ class=pf-c-nav__link>Ansible Edge GitOps</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/getting-started/ class=pf-c-nav__link>Getting Started</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/installation-details/ class="pf-c-nav__link pf-m-current">Installation Details</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/cluster-sizing/ class=pf-c-nav__link>Cluster Sizing</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/ansible-automation-platform/ class=pf-c-nav__link>Ansible Automation Platform</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/openshift-virtualization/ class=pf-c-nav__link>OpenShift Virtualization</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/ideas-for-customization/ class=pf-c-nav__link>Ideas for Customization</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://hybrid-cloud-patterns.io/patterns/ansible-edge-gitops/troubleshooting/ class=pf-c-nav__link>Troubleshooting</a></li></ul></div></div></div><main class=pf-c-page__main><section class=pf-c-page__main-section><div class="pf-l-grid pf-m-gutter"><div class="pf-l-grid__item pf-m-8-col"><div class=pf-c-content><div class=pf-c-content><h1 id=installation-details>Installation Details</h1><h1 id=installation-steps>Installation Steps</h1><p>These are the steps run by <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/Makefile>make install</a> and what each one does:</p><h2 id=operator-deployhttpsgithubcomhybrid-cloud-patternscommonblobmainmakefile><a href=https://github.com/hybrid-cloud-patterns/common/blob/main/Makefile>operator-deploy</a></h2><p>The operator-deploy task installs the Validated Patterns Operator, which in turn creates a subscription for the OpenShift GitOps operator and installs both the cluster and hub instances of it. The clustergroup application will then read the values-global.yaml and values-hub.yaml files for other subscriptions and applications to install.</p><p>The <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/Makefile>legacy-install</a> is still provided for users that cannot or do not want to use the Validated Patterns operator. Instead of installing the operator, it installs a helm chart that does the same thing - installs a subscription for OpenShift GitOps and installs a cluster-wide and hub instance of that operator. It then proceeds with installing the clustergroup application.</p><p>Note that both the <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/Makefile>upgrade</a> and <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/Makefile>legacy-upgrade</a> targets are now equivalent and interchangeable with <code>install</code> and <code>legacy-install</code> (respectively - <code>legacy-install/legacy-upgrade</code> are not compatible with standard <code>install/upgrade</code>. This was not always the case, so both install/upgrade targets are still provided).</p><h3 id=imperative-section>Imperative section</h3><p>Part of the operator-deploy process is creating and running the <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/values-hub.yaml>imperative</a> tools as defined in the hub values file. In this pattern, that includes running the playbook to deploy the metal worker.</p><p>The real code for this playbook (outside of a shell wrapper) is <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/ansible/deploy_kubevirt_worker.yml>here</a>.</p><p>This script is another Ansible playbook that deploys a node to run the Virtual Machines for the demo. The playbook uses the OpenShift machineset API to provision the node in the first availability zone it finds. Currently, AWS is the only major public cloud provider that offers the deployment of a metal node through the normal provisioning process. We hope that Azure and GCP will support this functionality soon as well.</p><p>Please be aware that the metal node is rather more expensive in compute costs than most other AWS machine types. The trade-off is that running the demo without hardware acceleration would take ~4x as long.</p><p>It takes about 20-30 minutes for the metal node to become available to run VMs. If you would like to see the current status of the metal node, you can check it this way (assuming your kubeconfig is currently set up to point to your cluster):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>oc get -A machineset
</span></span></code></pre></div><p>You will be looking for a machineset with <code>metal-worker</code> in its name:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>NAMESPACE               NAME                                        DESIRED   CURRENT   READY   AVAILABLE   AGE
</span></span><span style=display:flex><span>openshift-machine-api   mhjacks-aeg-qx25w-metal-worker-us-west-2a   1         1         1       1           19m
</span></span><span style=display:flex><span>openshift-machine-api   mhjacks-aeg-qx25w-worker-us-west-2a         1         1         1       1           47m
</span></span><span style=display:flex><span>openshift-machine-api   mhjacks-aeg-qx25w-worker-us-west-2b         1         1         1       1           47m
</span></span><span style=display:flex><span>openshift-machine-api   mhjacks-aeg-qx25w-worker-us-west-2c         1         1         1       1           47m
</span></span><span style=display:flex><span>openshift-machine-api   mhjacks-aeg-qx25w-worker-us-west-2d         0         0                             47m
</span></span></code></pre></div><p>When the <code>metal-worker</code> is showing &ldquo;READY&rdquo; and &ldquo;AVAILABLE&rdquo;, the virtual machines will begin provisioning on it.</p><p>The metal node will be destroyed when the cluster is destroyed. The script is idempotent and will create at most one metal node per cluster.</p><h2 id=post-installhttpsgithubcomhybrid-cloud-patternscommonblobmainmakefile><a href=https://github.com/hybrid-cloud-patterns/common/blob/main/Makefile>post-install</a></h2><p>Note that all the steps of <code>post-install</code> are idempotent. If you want or need to reconfigure vault or AAP, the recommended way to do so is to call <code>make post-install</code>. This may change as we move elements of this pattern into the new imperative framework in <code>common</code>.</p><p>Specific processes that are called by post-install include:</p><h3 id=vault-inithttpsgithubcomhybrid-cloud-patternscommonblobmainscriptsvault-utilssh><a href=https://github.com/hybrid-cloud-patterns/common/blob/main/scripts/vault-utils.sh>vault-init</a></h3><p>Vault requires extra setup in the form of unseal keys and configuration of secrets. The vault-init task does this. Note that it is safe to run vault-init as it will exit successfully if it can connect to a cluster with a running, unsealed vault.</p><h3 id=load-secretshttpsgithubcomhybrid-cloud-patternscommonblobmainscriptsvault-utilssh><a href=https://github.com/hybrid-cloud-patterns/common/blob/main/scripts/vault-utils.sh>load-secrets</a></h3><p>This process (which calls push_secrets) calls an Ansible playbook that reads the values-secret.yaml file and stores the data it finds there in vault as keypairs. These values are then usable in the kubernetes cluster. This pattern uses the ssh pubkey for the kiosk VMs via the external secrets operator.</p><p>This script will update secrets in vault if re-run; it is safe to re-run if the secret values have not changed as well.</p><h3 id=configure-controllerhttpsgithubcomhybrid-cloud-patternsansible-edge-gitopsblobmainscriptsansible_load_controllersh><a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/scripts/ansible_load_controller.sh>configure-controller</a></h3><p>There are two parts to this script - the first part, with the code <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/ansible/ansible_get_credentials.yml>here</a>, retrieves the admin credentials from OpenShift to enable login to the AAP Controller.</p><p>The second part, which is the bulk of the ansible-load-controller process is <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/ansible/ansible_configure_controller.yml>here</a> and uses the <a href=https://github.com/redhat-cop/controller_configuration>controller configuration</a> framework to configure the Ansible Automation Platform instance that is installed by the helm chart.</p><p>This division is so that users can adapt this pattern more easily if they&rsquo;re running AAP, but not on OpenShift.</p><p>The script waits until AAP is ready, and then proceeds to:</p><ol><li>Install the manifest to entitle AAP</li><li>Configure the custom Credential Types the demo needs</li><li>Define an Organization for the Demo</li><li>Add a Project for the Demo</li><li>Add the Credentials for jobs to use</li><li>Configure Host inventory and inventory sources, and smart inventories to define target hosts</li><li>Configure an Execution environment for the Demo</li><li>Configure Job Templates for the Demo</li><li>Configure Schedules for the jobs that need to repeat</li></ol><p><em>Note:</em> This script has defaults that it overrides when run as part of <code>make install</code> that it derives from the environment (the repo that it is attached to and the branch that it is on). So if you need to re-run it, the most straightforward way to do this is to run <code>make upgrade</code> when using the make-based installation process.</p><h1 id=openshift-gitops-argocd>OpenShift GitOps (ArgoCD)</h1><p>OpenShift GitOps is central to this pattern as it is responsible for installing all of the other components. The installation process is driven through the installation of the <a href=https://github.com/hybrid-cloud-patterns/common/tree/main/clustergroup>clustergroup</a> chart. This in turn reads the repo&rsquo;s <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/values-global.yaml>global values file</a>, which instructs it to read the <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/values-hub.yaml>hub values file</a>. This is how the pattern knows to apply the Subscriptions and Applications listed further in the pattern.</p><h1 id=odf-openshift-data-foundations>ODF (OpenShift Data Foundations)</h1><p>ODF is the storage framework that is needed to provide resilient storage for OpenShift Virtualization. It is managed via the helm chart <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/tree/main/charts/hub/openshift-data-foundations>here</a>. This is basically the same chart that our Medical Diagnosis pattern uses (see <a href=/medical-diagnosis/getting-started/#setting-up-the-storage-for-openshift-data-foundation>here</a> for details).</p><p>Please note that this chart will create a Noobaa S3 bucket named nb.epoch_timestamp.cluster-domain which will not be destroyed when the cluster is destroyed.</p><h1 id=openshift-virtualization-kubevirt>OpenShift Virtualization (KubeVirt)</h1><p>OpenShift Virtualization is a framework for running virtual machines as native Kubernetes resources. While it can run without hardware acceleration, the performance of virtual machines will suffer terribly; some testing on a similar workload indicated a 4-6x delay running without hardware acceleration, so at present this pattern requires hardware acceleration. The pattern provides a script <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/scripts/deploy_kubevirt_worker.sh>deploy-kubevirt-worker.sh</a> which will provision a metal worker to run virtual machines for the pattern.</p><p>OpenShift Virtualization currently supports only AWS and on-prem clusters; this is because of the way that baremetal resources are provisioned in GCP and Azure. We hope that OpenShift Virtualization can support GCP and Azure soon.</p><p>The installation of the OpenShift Virtualization HyperConverged deployment is controlled by the chart <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/tree/main/charts/hub/cnv>here</a>.</p><p>OpenShift Virtualization was chosen in this pattern to avoid dealing with the differences in galleries and templates of images between the different public cloud providers. The important thing from this pattern&rsquo;s standpoint is the availability of machine instances to manage (since we are simulating an Edge deployment scenario, which could either be bare metal instances or virtual machines); OpenShift Virtualization was the easiest and most portable way to spin up machine instances. It also provides mechanisms for defining the desired machine set declaratively.</p><p>The creation of virtual machines is controlled by the chart <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/tree/main/charts/hub/edge-gitops-vms>here</a>.</p><p>More details about the way we use OpenShift Virtualization are available <a href=/ansible-edge-gitops/openshift-virtualization>here</a>.</p><h1 id=ansible-automation-platform-aap-formerly-known-as-ansible-tower>Ansible Automation Platform (AAP, formerly known as Ansible Tower)</h1><p>The use of Ansible Automation Platform is really the centerpiece of this pattern. We have recognized for some time that the notion and design principles of GitOps should apply to things outside of Kubernetes, and we believe this pattern
gives us a way to do that.</p><p>All of the Ansible interactions are defined in a Git Repository; the Ansible jobs that configure the VMs are designed
to be idempotent (and are scheduled to run every 10 minutes on those VMs).</p><p>The installation of AAP itself is governed by the chart <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/tree/main/charts/hub/ansible-automation-platform>here</a>. The post-installation configuration of AAP is done via the <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/blob/main/scripts/ansible_load_controller.sh>ansible-load-controller.sh</a> script.</p><p>It is very much the intention of this pattern to make it easy to replace the specific Edge management use case with another one. Some ideas on how to do that can be found <a href=/ansible-edge-gitops/ideas-for-customization/>here</a>.</p><p>Specifics of the Ansible content for this pattern can be seen <a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/tree/main/ansible>here</a>.</p><p>More details of the specifics of how AAP is configured are available <a href=/ansible-edge-gitops/ansible-automation-platform/>here</a>.</p><h1 id=next-steps>Next Steps</h1><p><a href=https://groups.google.com/g/hybrid-cloud-patterns>Help & Feedback</a>{: .btn .fs-5 .mb-4 .mb-md-0 .mr-2 }
<a href=https://github.com/hybrid-cloud-patterns/ansible-edge-gitops/issues>Report Bugs</a>{: .btn .btn-red .fs-5 .mb-4 .mb-md-0 .mr-2 }</p></div></div></div><div class="pf-l-grid__item pf-m-4-col"><nav class="pf-c-jump-links pf-m-vertical" aria-label=Contents><div class=pf-c-jump-links__main><div class=pf-c-jump-links__header><div class=pf-c-jump-links__label><h1>Table of Contents</h1></div></div><nav id=TableOfContents><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#installation-details>Installation Details</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#installation-steps>Installation Steps</a><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#operator-deployhttpsgithubcomhybrid-cloud-patternscommonblobmainmakefile><a class=pf-c-jump-links__link href=https://github.com/hybrid-cloud-patterns/common/blob/main/Makefile>operator-deploy</a></a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#post-installhttpsgithubcomhybrid-cloud-patternscommonblobmainmakefile><a class=pf-c-jump-links__link href=https://github.com/hybrid-cloud-patterns/common/blob/main/Makefile>post-install</a></a></li></ul></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#openshift-gitops-argocd>OpenShift GitOps (ArgoCD)</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#odf-openshift-data-foundations>ODF (OpenShift Data Foundations)</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#openshift-virtualization-kubevirt>OpenShift Virtualization (KubeVirt)</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#ansible-automation-platform-aap-formerly-known-as-ansible-tower>Ansible Automation Platform (AAP, formerly known as Ansible Tower)</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#next-steps>Next Steps</a></li></ul></nav></div></nav></div></div></section></main></div><div><div style=padding:10px;text-align:center;color:#d2d2d2;background-color:#000>Copyright &copy; 2022 Red Hat, Inc.</div></div></body></html>